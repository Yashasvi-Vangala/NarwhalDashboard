<html>
	<head>        
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>
    NarwhalDashboard: guido
</title>

<link rel="shortcut icon" type="image/png" href="/../assets/icon.png"/>
<link rel="icon" type="image/png" href="/../assets/icon.png"/>

<link rel="stylesheet" href="/css/main.css">
        

        <script>
    var DISCONNECTED = 0;
    var CONNECTING = 1;
    var CONNECTED = 2;

    var socket;
    var state = DISCONNECTED;

    var autos = [];
    var json;

    var autoMenuVisible = false;
    var updater = null;

    function toggleConnection() {
        if (state == DISCONNECTED) {
            connect();
        }
        else {
            state = DISCONNECTED;
            
            socket.close();
            socket = null;
        }
    }
    
    function toggleCamConnection() {
        var x = element('cameraStream')
        if (x.style.display === "none") {
            x.style.display = "block";
            element('cam_conn_button').classList.remove('red');
            element('cam_conn_button').classList.remove('orange');
            element('cam_conn_button').classList.add('green');
            setInner('cam_conn_button_text', 'Camera Connected')
            element('cameraStream').src = 'http://10.31.28.2:1181/stream.mjpg' 
        } else {
            x.style.display = "none";
            element('cam_conn_button').classList.remove('green');
            element('cam_conn_button').classList.remove('orange');
            element('cam_conn_button').classList.add('red');
            setInner('cam_conn_button_text', 'Camera Disconnected')
            element('cameraStream').src = ''
        }
    }

    function connect() {
        //socket = new WebSocket("ws:roborio-3128-frc.local:5800");
        socket = new WebSocket("ws:10.31.28.2:5800");

        element('conn_button').classList.remove('red');
        element('conn_button').classList.remove('green');
        element('conn_button').classList.add('orange');
        setInner('conn_button_text', 'Connecting...');
        state = CONNECTING;
        
        socket.onopen = function(event) {
            console.log("Connected.")

            element('conn_button').classList.remove('red');
            element('conn_button').classList.remove('orange');
            element('conn_button').classList.add('green');
            setInner('conn_button_text', 'Connected');
            state = CONNECTED;
        };

        socket.onmessage = function(event) {
            json = JSON.parse(event.data);

            if ("" + autos != "" + json['auto_programs']) {
                autos = json['auto_programs'];

                setup_auto_chooser();
            }

            if (updater != null) {
                sel_auto = json['selected_auto']
                if (sel_auto == "null") {
                    sel_auto = "None";
                }
    
                setInner('selected_auto', sel_auto);
                setInner('match_time', Number(json['time']).toFixed(0));

                updater(json);
            }
        };

        socket.onclose = function(event) {
            // TODO: If disconnected by robot (i.e. not due to user manually clicking the connection button,
            // automatically try to reconnect.)
            
            state = DISCONNECTED;

            element('conn_button').classList.remove('green');
            element('conn_button').classList.remove('orange');
            element('conn_button').classList.add('red');
            setInner('conn_button_text', 'Disconnected');
        };
    }

    function addUpdater(u) {
        updater = u;
    }

    function setup_auto_chooser() {
        noneElement = document.getElementById("auto_choice_none")

        document.getElementById("auto_list").innerHTML = noneElement.outerHTML;

        for (var i = 0; i < autos.length; i++) {
            var element = noneElement.cloneNode(true);

            element.id = "auto_choice_" + i
            element.setAttribute('onclick', "select_auto(" + i + ")")
            element.innerHTML = autos[i]

            document.getElementById("auto_list").appendChild(element);
        }
    }

    function openAutoMenu() {
        document.getElementById('auto_list').style.display = 'block';
        autoMenuVisible = true;
    }

    function closeAutoMenu() {
        document.getElementById('auto_list').style.display = 'none';
        autoMenuVisible = false;
    }

    function toggleAutoMenu() {
        if (!autoMenuVisible) {
            openAutoMenu();
        }
        else {
            closeAutoMenu();
        }
    }

    function select_auto(i) {
        if (i == "-1") {
            send("selectAuto:null");
        }
        else {
            send("selectAuto:" + autos[Number(i)]);
        }
        closeAutoMenu();
    }

    function buttonDown(name) {
        send("button:" + name + ":down");
    }

    function buttonUp(name) {
        send("button:" + name + ":up");
    }

    function send(string_data) {
        if (state == CONNECTED) {
            socket.send(string_data);
            console.log("Sent \'" + string_data + "\'");
        }
        else {
            console.log("Attempted to send \'" + string_data + "\'");
        }
    }

    function element(id) {
        return document.getElementById(id);
    }

    function setInner(id, innerHTML) {
        element(id).innerHTML = innerHTML;
    }
</script>

        <script src="../assets/canvas-gauges/gauge.min.js"></script>
<script>
    var clear = "rgba(0,0,0,0)";

    function makeGauge(id, size, min, max, major_ticks, minor_ticks, highlights, needle_color, text_color, prog_color, dec, number_size) {
        var gauge = new RadialGauge({ 
            renderTo: id,
            width: size,
            height: size,
            minValue: min,
            maxValue: max,
            majorTicks: major_ticks,
            minorTicks: minor_ticks,
            barProgress: true,

            barWidth: "20%",

            colorPlate: clear,
            colorBorderOuter: clear,
            colorBorderOuterEnd: clear,
            colorBorderMiddle: clear,
            colorBorderMiddleEnd: clear,
            colorBorderInner: clear,
            colorBorderInnerEnd: clear,

            colorBorderShadow: "false",
            colorMajorTicks: text_color,
            colorNumbers: text_color,
            fontNumbersWeight: "700",
            fontNumbersSize: number_size,
            numbersMargin: 0,

            colorValueBoxRect: clear,
            colorValueBoxRectEnd: clear,
            colorValueBoxShadow: clear,
            colorValueTextShadow: clear,
            colorValueBoxBackground: clear,

            fontNumbers: "Open Sans",
            fontValue: "Open Sans",
            fontValueSize: "64",
            valueInt: 1,
            valueDec: dec,
            colorValueText: text_color,
            fontValueWeight: "700",

            colorNeedleShadowDown: clear,
            colorNeedleShadowUp: clear,
            colorNeedle: needle_color,
            colorNeedleEnd: needle_color,
            needleStart: 0,
            needleWidth: 8,
            colorNeedleCircleOuter: needle_color,
            colorNeedleCircleOuterEnd: needle_color,
            colorNeedleCircleInner: needle_color,
            colorNeedleCircleInnerEnd: needle_color,

            colorBarProgress: prog_color,

            highlights: highlights,
            highlightsWidth: 10,

            animation: false
        });

        return gauge;
    }

    function makeBar(id, width, height, min, max, major_ticks, minor_ticks, tick_side, highlights, tick_color, text_color, prog_color, dec, number_size) {
        var bar = new LinearGauge({ 
            renderTo: id,
            width: width,
            height: height,
            minValue: min,
            maxValue: max,
            majorTicks: major_ticks,
            minorTicks: minor_ticks,
            barProgress: true,
            
            tickSide: tick_side,
            numberSide: tick_side,

            barProgress: true,
            barWidth: "30",

            colorPlate: clear,
            colorBorderOuter: clear,
            colorBorderOuterEnd: clear,
            colorBorderMiddle: clear,
            colorBorderMiddleEnd: clear,
            colorBorderInner: clear,
            colorBorderInnerEnd: clear,

            colorValueBoxRect: clear,
            colorValueBoxRectEnd: clear,
            colorValueBoxShadow: clear,
            colorValueTextShadow: clear,
            colorValueBoxBackground: clear,

            colorMajorTicks: tick_color,
            colorMinorTicks: tick_color,

            colorNeedle: clear,
            colorNeedleEnd: clear,

            fontNumbers: "Open Sans",
            fontValue: "Open Sans",
            fontValueSize: "48",
            valueInt: 1,
            valueDec: dec,
            colorValueText: text_color,
            fontValueWeight: "700",

            barBeginCircle: false,

            colorBorderShadow: "false",
            colorNumbers: text_color,
            fontNumbersWeight: "700",
            fontNumbersSize: number_size,
            numbersMargin: 0,

            colorBarProgress: prog_color,

            highlights: highlights,
            highlightsWidth: 10,

            animation: false
        });

        return bar;
    }
</script>


        <script src="functions.js"></script>
<script>
    var battGauge;
    function updateData(json) { 
        battGauge.value = json['voltage'];
        battGauge.draw();

        sel_auto = json['selected_auto']
        if (sel_auto == "null") {
            sel_auto = "None";
        }
                
        setInner('selected_auto', sel_auto);
        setInner('match_time', Number(json['time']).toFixed(0));

        refresh(json);
    }

    function bodyLoad() {
        battGauge = makeGauge('batt_gauge', 160, 0, 15, [0,3,6,9,12,15], 3, [
            {from:  0, to:  8, color: "#d60000"},
            {from:  8, to: 12, color: "#efdb00"},
            {from: 12, to: 15, color: "#41c603"}
        ], "white", "white", "#0085b2", 2, 32);
        battGauge.value = 0;
        battGauge.draw();

        initialize();

        addUpdater(updateData);
    }
</script>
    </head>
    
	<body onload="bodyLoad()" class="squash" style="background: #efefef;">
        <div class="flexbox column squash" style="width: 100%;">
			<div class="flexbox row navy" style="align-items: center;flex-grow: 0; padding: 10px; margin: 0px">
    <div style="flex: 1 0 auto">
        <img style="height: 60px" src="../assets/logo.png"/>
    </div>
    
    <div id="conn_button" onclick='toggleConnection()' class="button red" style="flex: 0 0 auto; border-radius: 6px; padding: 10px; padding-left: 14px; padding-right: 14px;">
        <font id="conn_button_text" style="font-size: 20; font-weight: 700">Disconnected</font>
    </div>  
</div>
            
            <div class="flexbox row squash" style="align-items: stretch;">
                <div class="flexbox column squash" style="flex: 0 0 50%;">
                    <div style="display: flex; align-items: center; flex-direction: row; flex-grow: 0; margin: 25px; margin-bottom: 0px; padding: 16px; background: white; border-radius: 30px;">
                        <div id="battery" style="flex: 0 0 160px; height: 160px; background: #b0b0b0; border-radius: 14px; padding: 10px; color: white; text-align: center; vertical-align: middle;">
                            <font style="font-size: 18pt; line-height: 12pt">Battery</font>
                            <canvas id="batt_gauge"></canvas>  
                        </div>
                            
                        <div style="flex: 1 0 auto; text-align: center; vertical-align: middle;">
                            <font id="match_time" style="font-size: 60pt; line-height: 64pt">0s</font>
                            <br>
                            <font style="font-size: 18pt; line-height: 20pt">Match Time Remaining</font>
                        </div>
                    </div>
                        
                    <div style="display: flex; align-items: strech; flex-direction: column; flex-grow: 0; margin: 25px; margin-bottom: 0px; padding: 12px; background: #072682; border-radius: 16px;">
                        <div style="display: flex; align-items: center; flex-direction: row; color: white; font-size: 14pt;">
                            <font style="font-weight: 300; margin-right: 8px;">Selected Auto:</font>
                            <font id="selected_auto" style="font-weight: 600; flex: 1 0 auto">No autonomous selected</font>  
                            <div onclick='toggleAutoMenu()' class="button sapphire" style="border-radius: 6px; padding: 4px; padding-left: 14px; padding-right: 14px;">Choose</div>      
                        </div>
                        <div id="auto_list" style='display: none; margin-top: 10px;'>
                            <div id="auto_choice_none" onclick="select_auto(-1)" class="button sapphire" style="margin: 0px; margin-bottom: 4px; padding: 8px; border-radius: 6px;">
                                None
                            </div>
                        </div>
                    </div>

                    <div class="flexbox row" style="align-items: center; justify-content: center; margin: 25px; margin-bottom: 0px;">
                        <div style="text-align: center; flex: 0 0 auto">
    <font style="font-size: 14pt">Robot Speed (ft/s)</font>
    <br>
    <canvas id="speed_gauge"></canvas>
</div>
                    </div>
                </div>

                <div style="flex: 0 0 160px; text-align: center; padding: 20px; padding-right: 4px; padding-left: 4px;">
    <br>
    <font style="font-size: 14pt">Forklift Height (ft)</font>
    <br>
    <canvas id="fork_bar"></canvas>
</div>

<div class="flexbox column squash" style="flex: 1 0 auto; align-items: stretch; padding: 0px; padding: 16px">
    <div onmousedown='buttonDown("rezero")' onmouseup='buttonUp("rezero")' class="button navy" style="flex: 0 0 auto; border-radius: 12px; padding: 20px; margin-bottom: 10px;">
        <font style="font-size: 20">Rezero Forklift</font>
    </div> 
    <div onmousedown='buttonDown("stop_compress")' onmouseup='buttonUp("stop_compress")' class="button royal" style="flex: 0 0 auto; border-radius: 12px; padding: 20px; margin-bottom: 10px;">
        <font style="font-size: 20">Stop Compressor</font>
    </div> 
    <div onmousedown='buttonDown("start_compress")' onmouseup='buttonUp("start_compress")' class="button sapphire" style="flex: 0 0 auto; border-radius: 12px; padding: 20px; margin-bottom: 10px;">
        <font style="font-size: 20">Start Compressor</font>
    </div> 

    <div class="stream" style="text-align: center; flex: 0 0 auto; border-radius: 12px; padding: 20px; margin-bottom: 10px;">
        <!--
            TODO: Make the camera stream connect only after everything is loaded
            and/or allow the user to manually attempt to connect
        -->
        <div id="cam_conn_button" onclick='toggleCamConnection()' class="button red" style="flex: 0 0 auto; border-radius: 6px; padding: 10px; padding-left: 14px; padding-right: 14px;">
            <font id="cam_conn_button_text" style="font-size: 20; font-weight: 700">Camera Disconnected</font>
        </div> 
        <div id="adhamisbad">
            <img id="cameraStream" style="max-width:55vh; border-radius: 6px; padding: 14px; padding-left: 14px; padding-right: 14px; display: none;" src="">
        </div>
    </div> 
</div>
            </div>
        </div>
	</body>
</html>